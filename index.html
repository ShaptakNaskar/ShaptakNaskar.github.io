<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Business Card OCR (LLM + Camera)</title>
<style>
  body { font-family: system-ui, sans-serif; background:#f9f9f9; margin:0; padding:1rem; }
  h1 { text-align:center; font-size:1.5rem; }
  .container { max-width:480px; margin:auto; background:#fff; padding:1rem;
               border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  input[type=file]{display:block;margin:0.5rem 0;}
  button{display:block;width:100%;padding:0.75rem;font-size:1rem;margin:0.5rem 0;
         border:none;border-radius:4px;color:white;background:#0077ff;}
  #cameraContainer{display:none;text-align:center;}
  video,canvas {width:100%;border-radius:8px;margin-top:0.5rem;}
  .field{margin-bottom:0.75rem;}
  label{display:block;font-weight:600;margin-bottom:0.25rem;}
  input[type=text],input[type=email],input[type=tel]{width:100%;padding:0.5rem;
       border:1px solid #ccc;border-radius:4px;font-size:1rem;}
  #status{text-align:center;color:#0077ff;font-weight:bold;}
</style>
</head>
<body>
<div class="container">
  <h1>Business Card OCR (LLM + Camera)</h1>
  <p>Upload a photo or capture one with your camera.</p>
  <input id="imageInput" type="file" accept="image/*" capture="environment">
  <button id="cameraBtn">📷 Open Camera</button>

  <div id="cameraContainer">
    <video id="camera" autoplay playsinline></video>
    <button id="captureBtn">🎯 Capture Photo</button>
    <button id="closeCameraBtn" style="background:#999;">Close Camera</button>
    <canvas id="photoCanvas" style="display:none;"></canvas>
  </div>

  <div id="status"></div>

  <div id="formSection" style="display:none;">
    <div class="field"><label>Name</label><input id="name" type="text"></div>
    <div class="field"><label>Phone</label><input id="phone" type="tel"></div>
    <div class="field"><label>Email</label><input id="email" type="email"></div>
    <div class="field"><label>Address</label><input id="address" type="text"></div>
    <div class="field"><label>Company</label><input id="company" type="text"></div>
    <button id="downloadVCard">Generate vCard</button>
  </div>
</div>

<script>
// ============================
// CONFIG
// ============================
const OPENAI_API_KEY = "YOUR_OPENAI_API_KEY_HERE"; // <-- Replace with your key
const OPENAI_API_URL = "https://api.openai.com/v1/chat/completions";

// Elements
const imgInput = document.getElementById('imageInput');
const cameraBtn = document.getElementById('cameraBtn');
const cameraContainer = document.getElementById('cameraContainer');
const video = document.getElementById('camera');
const captureBtn = document.getElementById('captureBtn');
const closeCameraBtn = document.getElementById('closeCameraBtn');
const photoCanvas = document.getElementById('photoCanvas');
const statusDiv = document.getElementById('status');
const formSection = document.getElementById('formSection');
const fields = {
  name: document.getElementById('name'),
  phone: document.getElementById('phone'),
  email: document.getElementById('email'),
  address: document.getElementById('address'),
  company: document.getElementById('company')
};

let stream = null;

// ============================
// HELPERS
// ============================
function sanitize(s=''){
  return s.replace(/["':;]+/g,'').replace(/\s+/g,' ').trim();
}
function parseJsonLoose(str){
  try { return JSON.parse(str); }
  catch {
    const out = {};
    const lines = str.split(/\n|,/);
    lines.forEach(line=>{
      const m=line.match(/(Name|Phone Number|Email|Address|Company Name)\s*[:\-]?\s*(.*)/i);
      if(m) out[m[1]] = m[2];
    });
    return out;
  }
}

// ============================
//  OCR + Extraction
// ============================
async function processImage(base64) {
  statusDiv.textContent = "Sending to LLM...";
  formSection.style.display = "none";

  const prompt = `
You are a precise OCR and contact extractor AI.
Perform OCR + cleanup from the given business card image.
Return clean JSON with:
{Name:"", "Phone Number":"", "Email":"", "Address":"", "Company Name":""}
Each value must be clean, no quotes or colons inside.`;

  const body = {
    model: "gpt-4o-mini",
    messages: [
      { role: "system", content: "You extract structured contact info from images of business cards." },
      { role: "user", content: [
          { type: "text", text: prompt },
          { type: "image_url", image_url: { url: "data:image/jpeg;base64," + base64 } }
      ]}
    ],
    temperature: 0
  };

  try {
    const res = await fetch(OPENAI_API_URL, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": "Bearer " + OPENAI_API_KEY
      },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    const content = data.choices?.[0]?.message?.content || "{}";
    console.log('LLM Output:', content);
    const parsed = parseJsonLoose(content);

    fields.name.value = sanitize(parsed["Name"]);
    fields.phone.value = sanitize(parsed["Phone Number"]);
    fields.email.value = sanitize(parsed["Email"]);
    fields.address.value = sanitize(parsed["Address"]);
    fields.company.value = sanitize(parsed["Company Name"]);

    formSection.style.display = "block";
    statusDiv.textContent = "✅ Extraction complete.";
  } catch(err){
    console.error(err);
    statusDiv.textContent = "⚠️ LLM failed. Please retry.";
  }
}

// ============================
//  File Upload Handler
// ============================
imgInput.addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const base64 = await new Promise(r=>{
    const reader=new FileReader();
    reader.onload=()=>r(reader.result.split(',')[1]);
    reader.readAsDataURL(file);
  });
  await processImage(base64);
});

// ============================
//  Camera Capture Handlers
// ============================
cameraBtn.addEventListener('click', async ()=>{
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    cameraContainer.style.display = "block";
  } catch (err) {
    alert("Camera not available or permission denied.");
  }
});

closeCameraBtn.addEventListener('click', ()=>{
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
  cameraContainer.style.display = "none";
});

captureBtn.addEventListener('click', ()=>{
  if (!stream) return;
  const ctx = photoCanvas.getContext('2d');
  photoCanvas.width = video.videoWidth;
  photoCanvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  const dataUrl = photoCanvas.toDataURL('image/jpeg');
  const base64 = dataUrl.split(',')[1];
  cameraContainer.style.display = "none";
  if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; }
  processImage(base64);
});

// ============================
//  vCard Generation
// ============================
document.getElementById('downloadVCard').addEventListener('click', ()=>{
  const n = sanitize(fields.name.value);
  const p = sanitize(fields.phone.value);
  const e = sanitize(fields.email.value);
  const a = sanitize(fields.address.value);
  const c = sanitize(fields.company.value);

  const vcf = `BEGIN:VCARD
VERSION:3.0
N:${n}
FN:${n}
ORG:${c}
TEL;TYPE=CELL:${p}
EMAIL;TYPE=INTERNET:${e}
ADR;TYPE=WORK:;;${a}
END:VCARD`;

  const blob = new Blob([vcf], { type: "text/vcard" });
  const url = URL.createObjectURL(blob);
  const aTag = document.createElement('a');
  aTag.href = url;
  aTag.download = (n || 'contact') + '.vcf';
  aTag.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
