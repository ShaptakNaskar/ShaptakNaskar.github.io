<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Business Card OCR (LLM + Camera + API Key)</title>
<style>
  body { font-family: system-ui, sans-serif; background:#f9f9f9; margin:0; padding:1rem; }
  h1 { text-align:center; font-size:1.5rem; }
  .container { max-width:480px; margin:auto; background:#fff; padding:1rem;
               border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  input[type=file], input[type=password], input[type=text], input[type=tel], input[type=email]{width:100%;padding:0.5rem;margin:0.25rem 0;border:1px solid #ccc;
    border-radius:4px;font-size:1rem;}
  button{display:block;width:100%;padding:0.75rem;font-size:1rem;margin:0.5rem 0;
         border:none;border-radius:4px;color:white;background:#0077ff;}
  button.small{padding:0.4rem;font-size:0.85rem;width:auto;display:inline-block;}
  #cameraContainer{display:none;text-align:center;}
  video,canvas {width:100%;border-radius:8px;margin-top:0.5rem;}
  .field{margin-bottom:0.75rem;}
  label{display:block;font-weight:600;margin-bottom:0.25rem;}
  #status{text-align:center;color:#0077ff;font-weight:bold;margin-top:0.5rem;}
</style>
</head>
<body>
<div class="container">
  <h1>Business Card OCR (LLM + Camera)</h1>

  <div id="apiKeySection">
    <label for="apiKey">🔑 Enter your OpenAI API Key</label>
    <input id="apiKey" type="password" placeholder="sk-...">
    <button id="saveApiKey">Save API Key</button>
  </div>

  <div id="appSection" style="display:none;">
    <div style="text-align:right;">
      <button id="changeKey" class="small" style="background:#666;">Change API Key</button>
    </div>
    <p>Upload or capture a business card:</p>
<input id="imageInput" type="file" accept="image/*" capture="environment">
    <button id="cameraBtn">📷 Open Camera</button>

    <div id="cameraContainer">
      <video id="camera" autoplay playsinline></video>
      <button id="captureBtn">🎯 Capture Photo</button>
      <button id="closeCameraBtn" style="background:#999;">Close Camera</button>
      <canvas id="photoCanvas" style="display:none;"></canvas>
    </div>

    <div id="status"></div>

    <div id="formSection" style="display:none;">
      <div class="field"><label>Name</label><input id="name" type="text"></div>
      <div class="field"><label>Phone</label><input id="phone" type="tel"></div>
      <div class="field"><label>Email</label><input id="email" type="email"></div>
      <div class="field"><label>Address</label><input id="address" type="text"></div>
      <div class="field"><label>Company</label><input id="company" type="text"></div>
      <button id="downloadVCard">Generate vCard</button>
    </div>
  </div>
</div>

<script>
// ============================
// Setup
// ============================
const OPENAI_API_URL = "https://api.openai.com/v1/chat/completions";
let OPENAI_API_KEY = localStorage.getItem('openai_api_key') || null;
const statusDiv = document.getElementById('status');
const imgInput = document.getElementById('imageInput');
const cameraBtn = document.getElementById('cameraBtn');
const cameraContainer = document.getElementById('cameraContainer');
const video = document.getElementById('camera');
const captureBtn = document.getElementById('captureBtn');
const closeCameraBtn = document.getElementById('closeCameraBtn');
const photoCanvas = document.getElementById('photoCanvas');
const formSection = document.getElementById('formSection');
const fields = {
  name: document.getElementById('name'),
  phone: document.getElementById('phone'),
  email: document.getElementById('email'),
  address: document.getElementById('address'),
  company: document.getElementById('company')
};
let stream = null;

// Display correct section
if (OPENAI_API_KEY) {
  document.getElementById('apiKeySection').style.display = 'none';
  document.getElementById('appSection').style.display = 'block';
} else {
  document.getElementById('apiKeySection').style.display = 'block';
}

// ============================
// API Key Handling
// ============================
document.getElementById('saveApiKey').addEventListener('click', ()=>{
  const key = document.getElementById('apiKey').value.trim();
  if(!key.startsWith('sk-')){
    alert("Please enter a valid OpenAI API key (starts with sk-).");
    return;
  }
  OPENAI_API_KEY = key;
  localStorage.setItem('openai_api_key', key);
  document.getElementById('apiKeySection').style.display = 'none';
  document.getElementById('appSection').style.display = 'block';
});

document.getElementById('changeKey').addEventListener('click', ()=>{
  if(confirm("Remove saved API key?")) {
    localStorage.removeItem('openai_api_key');
    OPENAI_API_KEY = null;
    document.getElementById('apiKeySection').style.display = 'block';
    document.getElementById('appSection').style.display = 'none';
  }
});

// ============================
// Helpers
// ============================
function sanitize(s=''){ return s.replace(/["':;]+/g,'').replace(/\s+/g,' ').trim(); }
function parseJsonLoose(str){
  try { return JSON.parse(str); }
  catch {
    const out={};
    str.split(/\n|,/).forEach(line=>{
      const m=line.match(/(Name|Phone Number|Email|Address|Company Name)\s*[:\-]?\s*(.*)/i);
      if(m) out[m[1]] = m[2];
    });
    return out;
  }
}

// ============================
// Image Processing via LLM
// ============================
async function processImage(base64){
  if (!OPENAI_API_KEY) return alert("API key missing!");
  statusDiv.textContent = "Sending to LLM...";
  formSection.style.display = "none";

  const prompt = `
You are a precise OCR and contact extractor AI.
From this business card image, extract and sanitize the following:
- Name
- Phone Number
- Email
- Address
- Company Name
Return a pure JSON object like:
{"Name":"John Doe","Phone Number":"+1 9998887777","Email":"john@example.com","Address":"123 Main St, NYC","Company Name":"Example Inc"}
Values must have no quotes, colons or semicolons inside.`;

  const body = {
    model: "gpt-4o-mini",
    messages: [
      { role: "system", content: "You extract structured contact info from images of business cards." },
      { role: "user", content: [
          { type: "text", text: prompt },
          { type: "image_url", image_url: { url: "data:image/jpeg;base64," + base64 } }
      ]}
    ],
    temperature: 0
  };

  try {
    const res = await fetch(OPENAI_API_URL, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": "Bearer " + OPENAI_API_KEY
      },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    const content = data.choices?.[0]?.message?.content || "{}";
    console.log("LLM response:", content);
    const parsed = parseJsonLoose(content);

    fields.name.value = sanitize(parsed["Name"]);
    fields.phone.value = sanitize(parsed["Phone Number"]);
    fields.email.value = sanitize(parsed["Email"]);
    fields.address.value = sanitize(parsed["Address"]);
    fields.company.value = sanitize(parsed["Company Name"]);

    formSection.style.display = "block";
    statusDiv.textContent = "✅ Extraction complete.";
  } catch(err){
    console.error(err);
    statusDiv.textContent = "⚠️ LLM extraction failed. Check key or internet.";
  }
}

// ============================
// File Upload Handler
// ============================
imgInput.addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const base64 = await new Promise(r=>{
    const reader=new FileReader();
    reader.onload=()=>r(reader.result.split(',')[1]);
    reader.readAsDataURL(file);
  });
  processImage(base64);
});

// ============================
// Camera Capture
// ============================
cameraBtn.addEventListener('click', async ()=>{
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    cameraContainer.style.display = "block";
  } catch (err) {
    alert("Camera access denied or unavailable.");
  }
});
closeCameraBtn.addEventListener('click', ()=>{
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  cameraContainer.style.display = "none";
});
captureBtn.addEventListener('click', ()=>{
  const ctx = photoCanvas.getContext('2d');
  photoCanvas.width = video.videoWidth;
  photoCanvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  const dataUrl = photoCanvas.toDataURL('image/jpeg');
  const base64 = dataUrl.split(',')[1];
  cameraContainer.style.display = "none";
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  processImage(base64);
});

// ============================
// vCard Generator
// ============================
document.getElementById('downloadVCard').addEventListener('click', ()=>{
  const n = sanitize(fields.name.value);
  const p = sanitize(fields.phone.value);
  const e = sanitize(fields.email.value);
  const a = sanitize(fields.address.value);
  const c = sanitize(fields.company.value);
  const vcf = `BEGIN:VCARD
VERSION:3.0
N:${n}
FN:${n}
ORG:${c}
TEL;TYPE=CELL:${p}
EMAIL;TYPE=INTERNET:${e}
ADR;TYPE=WORK:;;${a}
END:VCARD`;
  const blob = new Blob([vcf], { type: "text/vcard" });
  const url = URL.createObjectURL(blob);
  const aTag = document.createElement('a');
  aTag.href = url;
  aTag.download = (n || 'contact') + '.vcf';
  aTag.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
